// perfil by Emmax - Fixed Version

import { xpRange } from '../lib/levelling.js'
import moment from 'moment-timezone'
import fetch from 'node-fetch'

let handler = async (m, { conn, args, usedPrefix }) => {
    try {
        // Definici√≥n de variables locales para evitar errores de "not defined"
        let currency = 'ü™ô' // Puedes cambiar el icono de la moneda aqu√≠
        let fkontak = { "key": { "participants":"0@s.whatsapp.net", "remoteJid": "status@broadcast", "fromMe": false, "id": "Halo" }, "message": { "contactMessage": { "vcard": `BEGIN:VCARD\nVERSION:3.0\nN:Sy;Bot;;;\nFN:y\nitem1.TEL;waid=${m.sender.split('@')[0]}:${m.sender.split('@')[0]}\nitem1.X-ABLabel:Ponsel\nEND:VCARD` } }, "participant": "0@s.whatsapp.net" }

        let who = m.mentionedJid && m.mentionedJid[0] ? m.mentionedJid[0] : m.quoted ? m.quoted.sender : m.sender
        let userId = who

        // Inicializar datos si no existen
        if (!global.db.data.users) global.db.data.users = {}
        if (!global.db.data.users[userId]) global.db.data.users[userId] = {}
        if (!global.db.data.characters) global.db.data.characters = {}
        
        const user = global.db.data.users[userId]
        
        // Obtenci√≥n del nombre segura
        let name = user.name || await conn.getName(userId) || userId.split('@')[0]

        // Datos del perfil
        const cumpleanos = user.birth || 'Sin especificar :< (#setbirth)'
        const genero = user.genre || 'Sin especificar'
        const pareja = user.marry
        const casado = pareja ? (global.db.data.users[pareja]?.name || await conn.getName(pareja) || pareja.split('@')[0]) : 'Nadie'
        const description = user.description || 'Sin descripci√≥n :v'
        const exp = user.exp || 0
        const nivel = user.level || 0
        const coin = user.coin || 0
        const bank = user.bank || 0
        const total = coin + bank

        // Ranking
        const sorted = Object.entries(global.db.data.users).map(([k, v]) => ({ ...v, jid: k })).sort((a, b) => (b.level || 0) - (a.level || 0))
        const rank = sorted.findIndex(u => u.jid === userId) + 1

        // Progreso de nivel
        const progreso = (() => {
            let datos = xpRange(nivel, global.multiplier || 1)
            let currentXp = exp - datos.min
            let percent = Math.max(0, Math.min(100, Math.floor((currentXp / datos.xp) * 100)))
            return `${currentXp.toLocaleString()} / ${datos.xp.toLocaleString()} _(${percent}%)_`
        })()

        // Premium status
        const premium = user.premium || (global.prems && global.prems.map(v => v.replace(/\D+/g, '') + '@s.whatsapp.net').includes(userId))
        const isLeft = premium ? (user.premiumTime ? await formatTime(user.premiumTime - Date.now()) : 'Permanente') : '‚Äî'

        // Harem y Favorito
        const favId = user.favorite
        const favLine = favId && global.db.data.characters?.[favId] ? `\n‡πë Claim favorito ¬ª *${global.db.data.characters[favId].name || '???'}*` : ''
        const ownedIDs = Object.entries(global.db.data.characters).filter(([, c]) => c.user === userId).map(([id]) => id)
        const haremCount = ownedIDs.length
        const haremValue = ownedIDs.reduce((acc, id) => acc + (global.db.data.characters[id].value || 0), 0)

        // Foto de perfil
        const pp = await conn.profilePictureUrl(userId, 'image').catch(_ => 'https://raw.githubusercontent.com/The-King-Destroy/Adiciones/main/Contenido/1745522645448.jpeg')

        const text = `*„Äå‚ú¶„Äç Perfil ‚ó¢ ${name} ‚ó§*
${description}

‚ùÄ Cumplea√±os ¬ª *${cumpleanos}*
‚ö• G√©nero ¬ª *${genero}*
‚ô° Casado con ¬ª *${casado}*

‚òÜ Experiencia ¬ª *${exp.toLocaleString()}*
‚ùñ Nivel ¬ª *${nivel}*
# Puesto ¬ª *#${rank}*
‚û® Progreso ¬ª *${progreso}*
‚∏ô Premium ¬ª ${premium ? `‚úîÔ∏è (*${isLeft}*)` : '‚úñÔ∏è'}

Íï• Harem ¬ª *${haremCount}*
‚ô§ Valor total ¬ª *${haremValue.toLocaleString()}*${favLine}
‚õÅ Coins totales ¬ª *${total.toLocaleString()} ${currency}*
‚ùí Comandos totales ¬ª *${user.commands || 0}*`

        await conn.sendMessage(m.chat, { image: { url: pp }, caption: text, mentions: [userId] }, { quoted: fkontak })

    } catch (error) {
        console.error(error)
        await m.reply(`‚ö†Ô∏é Se ha producido un problema.\n> Usa *${usedPrefix}report* para informarlo.\n\n${error.message}`)
    }
}

handler.help = ['profile']
handler.tags = ['rg']
handler.command = ['profile', 'perfil', 'perf√≠l']
handler.group = true

export default handler

async function formatTime(ms) {
    if (ms < 0) return 'Expirado'
    let s = Math.floor(ms / 1000), m = Math.floor(s / 60), h = Math.floor(m / 60), d = Math.floor(h / 24)
    let months = Math.floor(d / 30), weeks = Math.floor((d % 30) / 7)
    s %= 60; m %= 60; h %= 24; d %= 7
    let t = []
    if (months) t.push(`${months} mes${months > 1 ? 'es' : ''}`)
    if (weeks) t.push(`${weeks} semana${weeks > 1 ? 's' : ''}`)
    if (d) t.push(`${d} d√≠a${d > 1 ? 's' : ''}`)
    if (h) t.push(`${h} hora${h > 1 ? 's' : ''}`)
    if (m) t.push(`${m} min`)
    return t.length > 1 ? t.slice(0, -1).join(', ') + ' y ' + t.slice(-1) : t[0] || 'Segundos'
}
